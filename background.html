
<script src="util.js"/>
<script>

var BuildingQueue = {}
var Village = {}
var Background = {};
var XHR = {}

XHR.waitingQueue = new Array();

XHR.unlock = function() {
	if (XHR.waitingQueue.length > 0)
		XHR.waitingQueue.shift()();
}

XHR.lock = function (callback) {
	if (XHR.waitingQueue.length > 0) {
		XHR.waitingQueue.push(callback);
		return;
	} //else 
	callback();
}

XHR.lastDownload = 0;

XHR.getPage = function (suffix, params, callback) {
	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function() {
		 if (xhr.readyState == 4) {
		 	callback(xhr.status, xhr.responseText);
		 }
	}
	xhr.open("GET", "http://s3.travian.co.il/"+suffix, true);
	
	var sendRequest = function() {
		var now = new Date().getTime();
		if (now-XHR.lastDownload > 5000) {
			xhr.send();
			XHR.lastDownload = now;
		} else {
			setTimeout(sendRequest, 1000);
		}
	}
	
	sendRequest();

}


function toDOM(HTMLstring)
{
	var d = document.createElement('div');
	d.innerHTML = HTMLstring;
	var docFrag = document.createDocumentFragment();

	while (d.firstChild) {
	docFrag.appendChild(d.firstChild)
	};

	return docFrag;
}


BuildingQueue.resultToArray = function (sqlResultSet) {
	var res = new Array();
	for (var i=0; i < sqlResultSet.rows.length; ++i) {
		var row = sqlResultSet.rows.item(i);
		res.push({
			'villageId'	: parseInt(row['villageId']),
			'slotId'	: parseInt(row['slotId']),
			'priority'	: parseInt(row['priority']),
			'level'		: parseInt(row['level'])
		});
	}
	return res;
}




BuildingQueue.publish = function() {
	Background.Database.transaction(function(tx) {
		var query = "SELECT * FROM buildingQueues";
		var res = function (tx, result) {
			Comm.publish('BuildingQueuePublished', BuildingQueue.resultToArray(result));
		}
		tx.executeSql(query, [], res, Background.DatabaseErrorFunc);
	});
}

BuildingQueue.remove = function (villageId, slotId, level) {
	//alert('removing: '+villageId+", "+slotId+", level "+level);
	Background.Database.transaction(function(tx) {
	
		var res = function (tx, result) { 
			if (result.rowsAffected > 0) {
				Comm.publish('BuildingQueueChanged');
			}
		}; 
	
		tx.executeSql(
			"DELETE FROM buildingQueues "+
			"WHERE villageId=? AND slotId=? AND level=?",
			[villageId, slotId, level], res, Background.DatabaseErrorFunc);
	});
}

BuildingQueue.enqueue = function (villageId, slotId, level) {
	
	Background.Database.transaction(function(tx) {
		var res = function (tx, result) {
			if (result.rowsAffected > 0) {
				Comm.publish('BuildingQueueChanged');
			}
		}
		
		console.log('Enqueue building operation');
		var query = "INSERT INTO buildingQueues VALUES ("+
			"?, ?, (SELECT COALESCE (MAX(priority), 0)+1 FROM buildingQueues where villageId = ?), ?)";
		tx.executeSql(query, [villageId, slotId, villageId, level], res, Background.DatabaseErrorFunc);
	});
}



Village.construct = function (onSuccess, villageId, slotId, level) {
//	alert('constructing: '+villageId+", "+slotId+", level "+level);
	XHR.lock(function() {
		XHR.getPage("build.php?newdid="+villageId+"&id="+slotId, null, function(status, txt) {

		if (status != 200)
			return;
		parser = new DOMParser();
		filterXmlDoc = parser.parseFromString(txt, "text/xml");
		var n = XPath.getNode('//*[@id="contract"]//a[@class="build"]', filterXmlDoc);
		if (n == null)
			return;
		var link = XPath.getString('./@href', n);
		XHR.getPage(link, null, function(status, txt) {
		if (status == 200) {
			onSuccess();
		}
		});
		
		});
	});
}


Background.Database = null;
Background.DatabaseErrorFunc = function (tx, error) {
	console.log('ERROR');
	console.log(error);
}

Background.DatabaseResult = function (tx, result) {
	console.log('RESULT');
	console.log(result);
}

Background.timeoutId = null;


Background.togglePlayPause = function() {
	if (Background.timeoutId == null)
		Background.play();
	else
		Background.pause();
}

Background.play = function () {
	alert('Play');
	Background.run();
	Background.timeoutId = setTimeout(Background.run, 10*60*1000);
}

Background.pause = function () {
	if (Background.timeoutId != null) {
		alert('Puase');
		clearTimeout(Background.timeoutId);
		Background.timeoutId = null;
	}
}


Background.run = function () {
	// get all building queues top
	Background.Database.transaction(function(tx) {
		var query = 
			"SELECT villageId, slotId, level "+
			"FROM buildingQueues A "+
			"WHERE priority = ("+
				"SELECT MIN(priority) "+
				"FROM buildingQueues "+
				"WHERE villageId = A.villageId"+
			")";
		var res = function (tx, result) {
			
			for (var i=0; i < result.rows.length; ++i) {
				var row = result.rows.item(i);
				var villageId = row['villageId'];
				var slotId = row['slotId'];
				var level = row['level'];
				var onSuccess = (function (villageId, slotId, level) {
					return function() {
						BuildingQueue.remove(villageId, slotId, level)
					};
				})(villageId, slotId, level);
				Village.construct(onSuccess, villageId, slotId, level);
			}
		};
		console.log(query);
		tx.executeSql(query, [], res, Background.DatabaseErrorFunc);
	});
}

function tst () {
	alert('test !');
}

function init() {
	// init database
	try {
		Background.Database = openDatabase("TravianScript", "1.0", "TravianScript Database", 1024*64);
		if (!Background.Database)
			throw 'Error init database connectino';
	} catch(err) { 
		console.log(err);
	}
	
	Background.Database.transaction(function(tx) {
		var query = "CREATE TABLE IF NOT EXISTS buildingQueues ("+
			"villageId INTEGER, "+
			"slotId INTEGER NOT NULL, "+
			"priority INTEGER NOT NULL, "+
			"level INTEGER NOT NULL, "+
			"PRIMARY KEY(villageId, slotId, level))";
		console.log(query);
		tx.executeSql(query, [], Background.DatabaseResult, Background.DatabaseErrorFunc);
	});


	// show icon in address bar
	chrome.tabs.onUpdated.addListener(function (tabId, changeInfo, tab) {
		if (/\.travian\./.test(tab.url)) {
			chrome.pageAction.show(tabId);
		}
	});
	
	chrome.pageAction.onClicked.addListener(function (tab) {
		Background.togglePlayPause();
	});
	//Background.play();

	Comm.register('BuildingQueue.enqueue', BuildingQueue.enqueue);
	Comm.register('BuildingQueue.publish', BuildingQueue.publish);
	Comm.register('BuildingQueue.remove', BuildingQueue.remove);
	Comm.register('tst', tst);
}

init();

</script>
